name: Build and Release ESP32 Firmware

on:
    push:
        # when pull request is created, 2 github actions are triggered, one for push and one for pull_request
        # to avoid double builds, we only build on to pull_request
        #        branches:
        #            - '*'
        tags: [ 'v*' ]
    pull_request:
        branches: [ main ]

env:
    PLATFORMIO_CORE_VERSION: "6.1.18"

jobs:
    build:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                environment: [ esp32-s3-production ]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Cache PlatformIO
                uses: actions/cache@v4
                with:
                    path: |
                        ~/.cache/pip
                        ~/.platformio/.cache
                        ~/.platformio/packages
                    key: ${{ runner.os }}-pio
            -   name: Set up Python
                uses: actions/setup-python@v5
                with:
                    python-version: '3.11'

            -   name: Install PlatformIO
                run: |
                    pip install --upgrade platformio==${{ env.PLATFORMIO_CORE_VERSION }}

            -   name: Check GCC version  # Add this step
                run: |
                    gcc --version
                    g++ --version
                    echo "---"
                    which gcc
                    which g++

            -   name: Unit test
                run: |
                    pio test -e native -v

            -   name: Create secrets files from environment variables
                run: |
                    mkdir -p src/secrets
                    cat > src/secrets/general_secrets.h << EOF
                    #pragma once
                    #define GOOGLE_API_KEY "${{ secrets.GOOGLE_API_KEY }}"
                    #define ENCRYPTION_KEY "${{ secrets.ENCRYPTION_KEY }}"
                    #define RMV_API_KEY "${{ secrets.RMV_API_KEY }}"
                    EOF

            -   name: Build firmware
                run: |
                    pio run -e ${{ matrix.environment }}

            -   name: Create build info
                run: |
                    echo "Build Information" > build_info.txt
                    echo "==================" >> build_info.txt
                    echo "Commit: ${{ github.sha }}" >> build_info.txt
                    echo "Branch: ${{ github.ref_name }}" >> build_info.txt
                    echo "Environment: ${{ matrix.environment }}" >> build_info.txt
                    echo "Build Date: $(date -u)" >> build_info.txt
                    echo "PlatformIO Version: ${{ env.PLATFORMIO_CORE_VERSION }}" >> build_info.txt

            -   name: Upload firmware artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: firmware-${{ matrix.environment }}-${{ github.sha }}
                    path: |
                        .pio/build/${{ matrix.environment }}/*.bin
                        .pio/build/${{ matrix.environment }}/firmware.elf
                        build_info.txt
                    retention-days: 30

            -   name: Upload filesystem artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: filesystem-${{ matrix.environment }}-${{ github.sha }}
                    path: data/
                    retention-days: 30

    release:
        needs: build
        runs-on: ubuntu-latest
        strategy:
            matrix:
                environment: [ esp32-s3-production ]
        if: github.ref_type == 'tag'

        steps:
            -   name: Download all artifacts
                uses: actions/download-artifact@v5
                with:
                    path: artifacts
                    merge-multiple: true

            -   name: Create release package
                run: |
                    mkdir -p release
                    ls -al

                    # Copy firmware files
                    cp artifacts/.pio/build/${{ matrix.environment }}/*.bin release/
                    cp artifacts/.pio/build/${{ matrix.environment }}/firmware.elf release/
                    cp artifacts/build_info.txt release/
                    cp artifacts/*.html release/

                    # Create version info
                    cat > release/VERSION.txt << EOF
                    MyStation Firmware
                    Version: ${{ github.ref_name }}
                    Build: ${{ github.sha }}
                    Date: $(date -u)
                    EOF

                    # Create ZIP package
                    cd release
                    zip -r ../mystation-firmware-${{ github.sha }}.zip .
                    cd ..

            -   name: Create Release
                uses: softprops/action-gh-release@v2
                with:
                    files: |
                        mystation-firmware-${{ github.sha }}.zip
                        release/firmware.bin
                        release/bootloader.bin
                        release/firmware.elf
                        release/partitions.bin
                        release/build_info.txt
                        release/config_my_station.html
                        release/VERSION.txt
                    name: MyStation ${{ github.ref_name }}
                    body: |
                        # MyStation Firmware Release ${{ github.ref_name }}
                    draft: true
                    prerelease: false
                env:
                    GITHUB_TOKEN: ${{ secrets.ACTION_TOKEN }}
