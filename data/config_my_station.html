<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>MyStation Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background: #f4f6fa; color: #222; }
    .container { max-width: 800px; margin: 0 auto; padding: 1em; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; box-sizing: border-box; width: 100%; }
    h1 { font-size: 1.7em; margin-bottom: 1em; text-align: center; letter-spacing: 1px; }
    .chapter { font-size: 1.15em; font-weight: 600; color: #007aff; margin-top: 2em; margin-bottom: 0.5em; border-left: 4px solid #007aff; padding-left: 0.7em; background: #eaf6ff; border-radius: 6px; }
    .section { margin-bottom: 1.5em; }
    .label { font-weight: 500; margin-bottom: 0.2em; display: block; color: #333; }
    .row { display: flex; align-items: center; justify-content: space-between; }
    .edit-btn { background: none; border: none; color: #007aff; font-size: 1em; cursor: pointer; margin-left: 0.5em; }
    input[type=text], input[type=number], input[type=time], select { width: 100%; padding: 0.5em; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    .chips { display: flex; flex-wrap: wrap; gap: 0.3em; justify-content: flex-start; }
    .chip { display: inline-block; padding: 0.25em 0.8em; border-radius: 20px; background: #e0e0e0; cursor: pointer; user-select: none; font-size: 0.97em; margin-right: 0.2em; margin-bottom: 0.2em; white-space: nowrap; min-width: unset; }
    .chip.active { background: #007aff; color: #fff; }
    .config-item {
      margin-bottom: 1em;
      padding: 0.8em;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 3px solid #007aff;
    }
    .config-row {
      display: flex;
      align-items: center;
      gap: 0.5em;
      margin-bottom: 0.5em;
    }
    .config-row:last-child {
      margin-bottom: 0;
    }
    .time-range {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .time-range input[type=time] {
      width: auto;
      min-width: 120px;
    }
    .help-text {
      font-size: 0.85em;
      color: #666;
      margin-top: 0.3em;
      font-style: italic;
    }
    .warning {
      background: #fff3cd;
      border-left: 3px solid #ffc107;
      padding: 0.5em;
      margin-top: 0.5em;
      border-radius: 4px;
      font-size: 0.85em;
      color: #856404;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      color: #007aff;
      margin-left: 0.3em;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8em;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .privacy { font-size: 0.95em; color: #555; background: #eaf6ff; border-left: 4px solid #007aff; padding: 0.7em 1em; border-radius: 7px; margin-bottom: 1em; margin-top: 2em; max-width: 480px; width: 100%; box-sizing: border-box; display: block; text-align: left; margin-left: auto; margin-right: auto; }
    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em;
    }
    @media (max-width: 768px) {
      .config-grid {
        grid-template-columns: 1fr;
      }
      .config-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .time-range {
        flex-direction: column;
        width: 100%;
      }
      .time-range input[type=time] {
        width: 100%;
        min-width: unset;
      }
    }

    .display-mode-preview {
        margin-top: 0.5em;
        display: flex;
        gap: 0.5em;
        align-items: center;
    }

    .preview-box {
        width: 60px;
        height: 30px;
        border: 2px solid #007aff;
        border-radius: 4px;
        display: flex;
        font-size: 0.7em;
        align-items: center;
        justify-content: center;
        background: #f0f8ff;
    }

    .preview-half {
        width: 28px;
        height: 28px;
        border-right: 1px solid #007aff;
    }

    .preview-half:last-child {
        border-right: none;
        border-left: 1px solid #007aff;
    }

    .toggle-buttons {
        display: flex;
        gap: 0.5em;
        flex-wrap: wrap;
    }

    .toggle-btn {
        flex: 1;
        min-width: 150px;
        padding: 0.7em 1em;
        border: 2px solid #007aff;
        background: #fff;
        color: #007aff;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 500;
        text-align: center;
        transition: all 0.2s ease;
        user-select: none;
    }

    .toggle-btn:hover {
        background: #f0f8ff;
    }

    .toggle-btn.active {
        background: #007aff;
        color: #fff;
    }

    .ota-status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 0.5em;
    }

    .ota-status-indicator.enabled {
        background: #34c759;
    }

    .ota-status-indicator.disabled {
        background: #ff3b30;
    }

    /* Autocomplete suggestions styling */
    #city-suggestions, #stop-suggestions {
        position: relative;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 0.3em;
    }

    @media (max-width: 768px) {
      .toggle-buttons {
        flex-direction: column;
      }
      .toggle-btn {
        width: 100%;
        min-width: unset;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MyStation Status</h1>

    <!-- Display Mode Configuration Section (NEW) -->
    <div class="chapter">üì∫ Anzeige-Konfiguration</div>

    <div class="config-item">
      <div class="label">
          Anzeigemodus
          <span class="tooltip">‚ÑπÔ∏è
      <span class="tooltiptext">W√§hlen Sie, was auf dem Display angezeigt werden soll.</span>
    </span>
      </div>
      <div class="config-row">
          <select id="display-mode"
                  style="width:100%; padding:0.5em; font-size:1em; border:1px solid #ccc; border-radius:5px;"
                  onchange="updateDisplayModePreview()">
              <option value="0" selected>Wetter + Abfahrten (H√§lfte-H√§lfte)</option>
              <option value="1">Nur Wetter (Vollbild)</option>
              <option value="2">Nur Abfahrten (Vollbild)</option>
          </select>
      </div>
      <div class="display-mode-preview" id="display-preview">
          <div class="preview-box">
              <div class="preview-half">üå§Ô∏è</div>
              <div class="preview-half">üöå</div>
          </div>
          <span id="preview-text">Wetter links, Abfahrten rechts</span>
      </div>
      <div class="help-text">
          <strong>H√§lfte-H√§lfte:</strong> Wetter links, Abfahrten rechts - ideal f√ºr beide Informationen.<br>
          <strong>Nur Wetter:</strong> Vollbild-Wetterprognose mit Details und Grafiken.<br>
          <strong>Nur Abfahrten:</strong> Mehr Platz f√ºr Verkehrsinformationen und Details.
      </div>
    </div>

    <!-- Weather Configuration Section -->
    <div class="chapter">üå§Ô∏è Wetter-Konfiguration</div>

    <div class="config-item">
      <div class="label">
        Mein Standort
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Standort wird f√ºr Wetter- und Verkehrsdaten verwendet. Geben Sie Ihre Postleitzahl ein, um die Stadt zu finden.</span>
        </span>
      </div>
      <div class="config-row">
        <span id="city-display">{{CITY}}</span>
        <input type="text" id="city-input" style="display:none; width:100%; padding:0.5em; font-size:1em; border:1px solid #ccc; border-radius:5px;" placeholder="Postleitzahl eingeben (5 Ziffern)..." autocomplete="off" inputmode="numeric" pattern="[0-9]*">
        <button type="button" class="edit-btn" onclick="editCity()">‚úèÔ∏è</button>
        <input type="hidden" id="city-lat" value="{{LAT}}">
        <input type="hidden" id="city-lon" value="{{LON}}">
      </div>
      <div id="city-suggestions" style="display:none;"></div>
      <div class="help-text">
        Postleitzahl eingeben, um Stadt automatisch zu finden. Breitengrad: <span id="lat-display">{{LAT}}</span>, L√§ngengrad: <span id="lon-display">{{LON}}</span>
      </div>
    </div>

    <div class="config-item">
      <div class="label">
        Wetter-API Aktualisierungsintervall
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Empfohlen: alle 3 Stunden. L√§ngere Intervalle sparen Batterie und reduzieren Aktualisierungen.</span>
        </span>
      </div>
      <div class="config-row">
        <select id="weather-interval">
          <option value="1">Jede Stunde</option>
          <option value="2">Alle 2 Stunden</option>
          <option value="3" selected>Alle 3 Stunden (empfohlen)</option>
          <option value="6">Alle 6 Stunden</option>
          <option value="12">Alle 12 Stunden</option>
          <option value="24">Einmal t√§glich</option>
        </select>
      </div>
      <div class="help-text">Wetter √§ndert sich nicht so schnell. 3 Stunden Intervall ist optimal f√ºr Batterielebensdauer.</div>
    </div>

    <!-- √ñPNV Configuration Section -->
    <div class="chapter" style="display: flex; align-items: center; justify-content: space-between;">
      <span>üöå √ñPNV-Konfiguration</span>
      <img alt="Logo: RMV, Rhein-Main-Verkehrsverbund" src="rmv.svg" width="148" height="30" style="margin-left: auto;">
    </div>
    <div class="config-item">
      <div class="label">
        Meine Haltestelle
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">W√§hlen Sie Ihre h√§ufig genutzte Haltestelle aus oder geben Sie sie manuell ein.</span>
        </span>
      </div>
      <div class="config-row">
        <select id="stop-select" style="width:100%; padding:0.5em; font-size:1em; border:1px solid #ccc; border-radius:5px;">{{STOPS}}</select>
        <input type="text" id="stop-input" style="display:none; width:100%; padding:0.5em; font-size:1em; border:1px solid #ccc; border-radius:5px; margin-left:0.5em;" placeholder="Haltestelle eingeben..." autocomplete="off">
        <button type="button" class="edit-btn" onclick="editStop()">‚úèÔ∏è</button>
      </div>
      <div id="stop-suggestions" style="display:none;"></div>
      <div class="help-text">Automatisch gefundene Haltestellen oder manuell eingeben</div>
    </div>

    <div class="config-item">
      <div class="label">
        Verkehrsmittel-Filter
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">W√§hlen Sie die Verkehrsmittel aus, die Sie nutzen m√∂chten.</span>
        </span>
      </div>
      <div class="chips" id="filter-chips" style="display: flex; flex-wrap: wrap; gap: 0.3em; justify-content: flex-start;">
        <div class="chip active" data-type="R" onclick="toggleChip(this)">RB/RE</div>
        <div class="chip active" data-type="S" onclick="toggleChip(this)">S-Bahn</div>
        <div class="chip active" data-type="U" onclick="toggleChip(this)">U-Bahn</div>
        <div class="chip active" data-type="Tram" onclick="toggleChip(this)">Tram</div>
        <div class="chip active" data-type="Bus" onclick="toggleChip(this)">Busse</div>
        <div class="chip active" data-type="Ferry" onclick="toggleChip(this)">F√§hre</div>
      </div>
    </div>

    <div class="config-grid">
      <div class="config-item">
        <div class="label">
          Abfahrten Aktualisierungsintervall
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Wie oft sollen Abfahrtszeiten aktualisiert werden? H√§ufigere Updates verbrauchen mehr Batterie.</span>
          </span>
        </div>
        <div class="config-row">
          <select id="transport-interval">
            <option value="1">Jede Minute</option>
            <option value="2">Alle 2 Minuten</option>
            <option value="3" selected>Alle 3 Minuten</option>
            <option value="5">Alle 5 Minuten</option>
            <option value="10">Alle 10 Minuten</option>
            <option value="15">Alle 15 Minuten</option>
            <option value="30">Alle 30 Minuten</option>
          </select>
        </div>
        <div class="help-text">K√ºrzere Intervalle zeigen aktuellere Daten, verbrauchen aber mehr Batterie.</div>
      </div>

      <div class="config-item">
        <div class="label">
          Gehzeit zur Haltestelle
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tooltiptext">Busse/Bahnen, die in weniger als dieser Zeit abfahren, werden ausgeblendet.</span>
          </span>
        </div>
        <div class="config-row">
          <input type="number" id="walking-time" min="0" max="30" value="{{WALKING_TIME}}" style="width: 100px;">
          <span>Minuten</span>
        </div>
        <div class="help-text">Filtert zu kurzfristige Abfahrten aus. Standard: 5 Minuten Gehzeit.</div>
      </div>
    </div>

    <div class="config-item">
      <div class="label">
        Aktive Zeiten f√ºr Abfahrten-Updates
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Nur in diesen Zeiten werden Abfahrtszeiten aktualisiert. Au√üerhalb: Deep Sleep f√ºr maximale Batterieschonung.</span>
        </span>
      </div>
      <div class="config-row">
        <div class="time-range">
          <span>Von:</span>
          <input type="time" id="transport-active-start" value="{{TRANSPORT_ACTIVE_START}}">
          <span>Bis:</span>
          <input type="time" id="transport-active-end" value="{{TRANSPORT_ACTIVE_END}}">
        </div>
      </div>
      <div class="help-text">Nur w√§hrend dieser Zeiten werden Abfahrten aktualisiert. Au√üerhalb: Deep Sleep spart Batterie.</div>
    </div>

    <!-- Deep Sleep Configuration -->
    <div class="chapter">üí§ Energiespar-Konfiguration</div>

    <div class="config-item">
      <div class="label">
        Deep Sleep Zeiten
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">In diesen Zeiten macht das Ger√§t keine Updates und spart maximal Batterie.</span>
        </span>
      </div>
      <div class="config-row">
        <div class="time-range">
          <span>Nachtruhe von:</span>
          <input type="time" id="sleep-start" value="{{SLEEP_START}}">
          <span>bis:</span>
          <input type="time" id="sleep-end" value="{{SLEEP_END}}">
        </div>
      </div>
      <div class="warning">
        üí° W√§hrend Deep Sleep werden keine Updates durchgef√ºhrt und das Display bleibt unver√§ndert. Dies maximiert die Batterielebensdauer.
      </div>
    </div>

    <div class="config-item">
      <div class="label">
        Wochenend-Modus
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Andere Zeiten am Wochenende f√ºr l√§ngeres Ausschlafen.</span>
        </span>
      </div>
      <div class="config-row">
        <input type="checkbox" id="weekend-mode" {{WEEKEND_MODE}}>
        <span>Andere Zeiten am Wochenende</span>
      </div>
      <div id="weekend-config" style="display: none; margin-top: 0.5em;">
        <div class="config-row">
          <div class="time-range">
            <span>Wochenende Abfahrten aktiv:</span>
            <input type="time" id="weekend-transport-start" value="{{WEEKEND_TRANSPORT_START}}">
            <span>bis:</span>
            <input type="time" id="weekend-transport-end" value="{{WEEKEND_TRANSPORT_END}}">
          </div>
        </div>
        <div class="config-row">
          <div class="time-range">
            <span>Wochenende Sleep:</span>
            <input type="time" id="weekend-sleep-start" value="{{WEEKEND_SLEEP_START}}">
            <span>bis:</span>
            <input type="time" id="weekend-sleep-end" value="{{WEEKEND_SLEEP_END}}">
          </div>
        </div>
      </div>
    </div>

    <div class="config-item">
      <div class="label">
        Gesch√§tzte Batterienutzung
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Basierend auf Ihren Einstellungen: Weniger Aktualisierungen = l√§ngere Batterielebensdauer. Berechnung pro Wochentag.</span>
        </span>
      </div>
      <div class="config-row">
        <div id="battery-usage-info" style="background: #e8f5e8; padding: 0.5em; border-radius: 4px; width: 100%;">
          <div id="battery-summary" style="font-weight: 500; margin-bottom: 0.3em;">
            ‚ö° <span id="total-calls-per-day">0</span> Aktualisierungen pro Tag
          </div>
          <div style="font-size: 0.85em; color: #666;">
            üå§Ô∏è Wetter: <span id="weather-calls">0</span> Updates ‚Ä¢
            üöå √ñPNV: <span id="transport-calls">0</span> Updates ‚Ä¢
            üí§ Sleep: <span id="sleep-hours">0</span>h
          </div>
        </div>
      </div>
      <div class="help-text" id="battery-recommendation">
        Optimale Einstellung f√ºr Batterielebensdauer
      </div>
    </div>

    <!-- OTA Firmware Update Configuration Section -->
    <div class="chapter">üîÑ Firmware-Aktualisierung</div>

    <div class="config-item">
      <div class="label">
        Automatische Firmware-Updates
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Aktivieren Sie automatische Updates, um die neueste Firmware-Version zu erhalten.</span>
        </span>
      </div>
      <div class="config-row">
        <div class="toggle-buttons">
          <div class="toggle-btn active" id="ota-enabled-btn" onclick="toggleOTA(true)">
            <span class="ota-status-indicator enabled"></span>
            Aktiviert
          </div>
          <div class="toggle-btn" id="ota-disabled-btn" onclick="toggleOTA(false)">
            <span class="ota-status-indicator disabled"></span>
            Deaktiviert
          </div>
        </div>
      </div>
      <div class="help-text">
        Wenn aktiviert, pr√ºft das Ger√§t t√§glich auf neue Firmware-Versionen und installiert diese automatisch.
      </div>
    </div>

    <div class="config-item" id="ota-check-time-container">
      <div class="label">
        Pr√ºfzeit f√ºr Updates
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Zu welcher Uhrzeit soll t√§glich nach Updates gesucht werden?</span>
        </span>
      </div>
      <div class="config-row">
        <input type="time" id="ota-check-time" value="{{OTA_CHECK_TIME}}" style="width: auto; min-width: 120px;">
      </div>
      <div class="help-text">
        Das Ger√§t pr√ºft t√§glich zu dieser Uhrzeit, ob eine neue Firmware-Version verf√ºgbar ist.
      </div>
      <div class="warning">
        ‚ö†Ô∏è W√§hrend der Aktualisierung ist das Ger√§t f√ºr ca. 1-2 Minuten nicht verf√ºgbar. Die Aktualisierung erfolgt automatisch nach erfolgreicher Pr√ºfung.
      </div>
    </div>

    <!-- Netzwerk Section -->
    <div class="chapter">üì∂ Netzwerk-Information</div>

    <div class="config-item">
      <div class="label">
        Router-Verbindung
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Aktuell verbundenes WLAN-Netzwerk.</span>
        </span>
      </div>
      <div class="config-row">
        <span id="router">{{ROUTER}}</span>
      </div>
    </div>

    <div class="config-item">
      <div class="label">
        IP-Adresse
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Lokale Netzwerk-Adresse des Ger√§ts.</span>
        </span>
      </div>
      <div class="config-row">
        <span id="ip">{{IP}}</span>
      </div>
    </div>

    <div class="config-item">
      <div class="label">
        mDNS-Adresse
        <span class="tooltip">‚ÑπÔ∏è
          <span class="tooltiptext">Lokaler Hostname f√ºr einfachen Zugriff im Netzwerk ohne IP-Adresse zu merken.</span>
        </span>
      </div>
      <div class="config-row">
        <span id="mdns">{{MDNS}}</span>
      </div>
      <div class="help-text">Erreichbar √ºber: http://{{MDNS}} (falls mDNS im Netzwerk unterst√ºtzt wird)</div>
    </div>

    <div class="section" style="text-align:center; margin-top:2em;">
      <button id="save-btn" style="background:#007aff;color:#fff;border:none;padding:0.8em 2em;font-size:1.1em;border-radius:6px;cursor:pointer;box-shadow:0 1px 4px #0002;">Speichern</button>
    </div>

    <div class="privacy" style="margin-top:2em; margin-left:auto; margin-right:auto; max-width:800px; width:100%; box-sizing:border-box; display:block; text-align:left;">
      <strong>Datenschutzhinweis:</strong> Ihr Standort wird ausschlie√ülich √ºber die IP-Adresse Ihres Routers und √∂ffentliche Geodatenbanken ermittelt. Es werden keine GPS-Daten oder pers√∂nliche Bewegungsprofile verwendet. Die Standortdaten werden nur zur Anzeige und f√ºr die Wetter-/Stationssuche genutzt und nicht an Dritte weitergegeben.
    </div>
  </div>

  <script>
    // OTA toggle functionality
    function toggleOTA(enabled) {
      var enabledBtn = document.getElementById('ota-enabled-btn');
      var disabledBtn = document.getElementById('ota-disabled-btn');
      var checkTimeContainer = document.getElementById('ota-check-time-container');

      if (enabled) {
        enabledBtn.classList.add('active');
        disabledBtn.classList.remove('active');
        checkTimeContainer.style.display = 'block';
      } else {
        enabledBtn.classList.remove('active');
        disabledBtn.classList.add('active');
        checkTimeContainer.style.display = 'none';
      }
    }

    // Display mode preview functionalit
    function updateDisplayModePreview() {
      const displayMode = document.getElementById('display-mode').value;
      const previewBox = document.querySelector('.preview-box');
      const previewText = document.getElementById('preview-text');

      switch (displayMode) {
          case '0': // Half and half
              previewBox.innerHTML = '<div class="preview-half">üå§Ô∏è</div><div class="preview-half">üöå</div>';
              previewText.textContent = 'Wetter links, Abfahrten rechts';
              break;
          case '1': // Weather only
              previewBox.innerHTML = 'üå§Ô∏èüìä';
              previewText.textContent = 'Vollbild Wetterprognose mit Details';
              break;
          case '2': // Departure only
              previewBox.innerHTML = 'üöåüìã';
              previewText.textContent = 'Vollbild Abfahrtszeiten mit Details';
              break;
      }
    }

    // --- Stadt bearbeiten ---
    function editCity() {
      document.getElementById('city-display').style.display = 'none';
      document.getElementById('city-input').style.display = '';
      document.getElementById('city-input').value = '';
      document.getElementById('city-input').focus();
    }

    // --- Haltestelle bearbeiten ---
    function editStop() {
      document.getElementById('stop-select').style.display = 'none';
      document.getElementById('stop-input').style.display = '';
      document.getElementById('stop-input').value = '';
      document.getElementById('stop-input').focus();
      // Copy current selection to input field
      var currentSelection = document.getElementById('stop-select');
      if (currentSelection.selectedIndex >= 0) {
        document.getElementById('stop-input').value = currentSelection.options[currentSelection.selectedIndex].text;
      }
    }

    // --- Filter Chips ---
    function toggleChip(el) {
      el.classList.toggle('active');
    }

    // --- Stop select population ---
    function populateStops() {
      var select = document.getElementById('stop-select');
      if (!window.stopsData) return;
      select.innerHTML = '';
      window.stopsData.forEach(function(stop) {
        var opt = document.createElement('option');
        opt.value = stop.id;
        opt.textContent = stop.name;
        select.appendChild(opt);
      });
      if (window.selectedStopId) {
        select.value = window.selectedStopId;
      }
    }
    if (window.stopsData) populateStops();

    // --- Event Handlers ---
    var stopSelect = document.getElementById('stop-select');
    var stopInput = document.getElementById('stop-input');
    var stopSuggestions = document.getElementById('stop-suggestions');
    var cityInput = document.getElementById('city-input');
    var citySuggestions = document.getElementById('city-suggestions');

    // Handle manual stop entry switching back to select
    stopInput.addEventListener('blur', function() {
      setTimeout(function() {
        stopSuggestions.style.display = 'none';
        if (stopInput.style.display !== 'none' && stopInput.value.trim() === '') {
          stopInput.style.display = 'none';
          stopSelect.style.display = '';
        }
      }, 200);
    });

    // Handle manual city entry
    cityInput.addEventListener('blur', function() {
      setTimeout(function() {
        citySuggestions.style.display = 'none';
        if (cityInput.style.display !== 'none' && cityInput.value.trim() === '') {
          cityInput.style.display = 'none';
          document.getElementById('city-display').style.display = '';
        } else if (cityInput.value.trim() !== '') {
          document.getElementById('city-display').textContent = cityInput.value.trim();
          cityInput.style.display = 'none';
          document.getElementById('city-display').style.display = '';
        }
      }, 200);
    });

    // Handle city input suggestions (postal code search)
    cityInput.addEventListener('input', function() {
      var q = cityInput.value.trim();
      // Trigger search after 5 digits (postal code)
      if (q.length < 5 || !/^\d+$/.test(q)) {
        citySuggestions.style.display = 'none';
        return;
      }
      fetch('/api/city?q=' + encodeURIComponent(q))
        .then(r => r.json())
        .then(suggestions => {
          citySuggestions.innerHTML = '';
          suggestions.forEach(function(cityData) {
            var div = document.createElement('div');
            // Show full display name (e.g., "60311, Frankfurt am Main, Hessen, Deutschland")
            div.textContent = cityData.display || cityData.name || cityData;
            div.style.padding = '0.5em';
            div.style.cursor = 'pointer';
            div.style.borderBottom = '1px solid #eee';
            div.onmouseover = function() { div.style.background = '#f0f8ff'; };
            div.onmouseout = function() { div.style.background = '#fff'; };
            div.onclick = function() {
              // Use city name for display, but show lat/lon were set
              document.getElementById('city-display').textContent = cityData.name || cityData.display;
              cityInput.value = cityData.name || cityData.display;
              if (cityData.lat && cityData.lon) {
                document.getElementById('city-lat').value = cityData.lat;
                document.getElementById('city-lon').value = cityData.lon;
                document.getElementById('lat-display').textContent = parseFloat(cityData.lat).toFixed(4);
                document.getElementById('lon-display').textContent = parseFloat(cityData.lon).toFixed(4);
              }
              citySuggestions.style.display = 'none';
              cityInput.style.display = 'none';
              document.getElementById('city-display').style.display = '';
            };
            citySuggestions.appendChild(div);
          });
          if (suggestions.length > 0) {
            citySuggestions.style.display = 'block';
          } else {
            citySuggestions.style.display = 'none';
          }
        })
        .catch(function(err) {
          console.error('City search error:', err);
          citySuggestions.style.display = 'none';
        });
    });

    // Handle Enter key for city input
    cityInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        if (cityInput.value.trim() !== '') {
          document.getElementById('city-display').textContent = cityInput.value.trim();
        }
        cityInput.style.display = 'none';
        document.getElementById('city-display').style.display = '';
      }
    });

    // Handle Enter key for stop input
    stopInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        stopSuggestions.style.display = 'none';
        if (stopInput.value.trim() === '') {
          stopInput.style.display = 'none';
          stopSelect.style.display = '';
        }
      }
    });

    // Handle stop input suggestions
    stopInput.addEventListener('input', function() {
      var q = stopInput.value.trim();
      if (q.length < 5) {
        stopSuggestions.style.display = 'none';
        return;
      }
      fetch('/api/stop?q=' + encodeURIComponent(q))
        .then(r => r.json())
        .then(suggestions => {
          stopSuggestions.innerHTML = '';
          suggestions.forEach(function(stopData) {
            var div = document.createElement('div');
            div.textContent = stopData.name || stopData;
            div.style.padding = '0.5em';
            div.style.cursor = 'pointer';
            div.style.borderBottom = '1px solid #eee';
            div.onmouseover = function() { div.style.background = '#f0f8ff'; };
            div.onmouseout = function() { div.style.background = '#fff'; };
            div.onclick = function() {
              stopInput.value = stopData.name || stopData;
              if (stopData.id) {
                stopInput.setAttribute('data-stop-id', stopData.id);
              }
              stopSuggestions.style.display = 'none';
            };
            stopSuggestions.appendChild(div);
          });
          if (suggestions.length > 0) {
            stopSuggestions.style.display = 'block';
          } else {
            stopSuggestions.style.display = 'none';
          }
        })
        .catch(function(err) {
          console.error('Stop search error:', err);
          stopSuggestions.style.display = 'none';
        });
    });

    // --- Save config handler ---
    document.getElementById('save-btn').onclick = function() {
      var displayMode = document.getElementById('display-mode').value;
      var city = '';
      var cityDisplay = document.getElementById('city-display');
      var cityInput = document.getElementById('city-input');
      if (cityInput.style.display !== 'none') {
        city = cityInput.value.trim();
        if (city) cityDisplay.textContent = city;
      } else {
        city = cityDisplay.textContent;
      }

      var cityLat = document.getElementById('city-lat') ? document.getElementById('city-lat').value : '';
      var cityLon = document.getElementById('city-lon') ? document.getElementById('city-lon').value : '';
      var stopId = '';
      var stopName = '';
      var stopSelect = document.getElementById('stop-select');
      var stopInput = document.getElementById('stop-input');
      if (stopInput && stopInput.style.display !== 'none') {
        stopName = stopInput.value;
        // Get stop ID from data attribute if it was set by autocomplete
        stopId = stopInput.getAttribute('data-stop-id') || '__manual__';
      } else if (stopSelect) {
        stopId = stopSelect.value;
        stopName = stopSelect.options[stopSelect.selectedIndex] ? stopSelect.options[stopSelect.selectedIndex].text : '';
      }

      // Validate "stop-select" for display modes 0 and 2
      if ((displayMode === '0' || displayMode === '2') && (!stopId || stopId.trim() === '')) {
          alert('Bitte w√§hlen Sie eine Haltestelle aus, um den Anzeigemodus zu speichern.');
          return;
      }

      // Validate "city-lat" and "city-lon" for display modes 0 and 1
      if ((displayMode === '0' || displayMode === '1') && (cityLat.trim() === '' || cityLon.trim() === '')) {
          alert('Bitte geben Sie g√ºltige Breitengrad- und L√§ngengradwerte ein, um den Anzeigemodus zu speichern.');
          return;
      }

      var filterChips = document.querySelectorAll('.chip.active');
      var filters = Array.from(filterChips).map(function(chip) { return chip.getAttribute('data-type'); });

      var weatherInterval = document.getElementById('weather-interval').value;
      var transportInterval = document.getElementById('transport-interval').value;
      var transportActiveStart = document.getElementById('transport-active-start').value;
      var transportActiveEnd = document.getElementById('transport-active-end').value;
      var walkingTime = document.getElementById('walking-time').value;
      var sleepStart = document.getElementById('sleep-start').value;
      var sleepEnd = document.getElementById('sleep-end').value;
      var weekendMode = document.getElementById('weekend-mode').checked;
      var weekendTransportStart = document.getElementById('weekend-transport-start').value;
      var weekendTransportEnd = document.getElementById('weekend-transport-end').value;
      var weekendSleepStart = document.getElementById('weekend-sleep-start').value;
      var weekendSleepEnd = document.getElementById('weekend-sleep-end').value;

      // OTA configuration
      var otaEnabled = document.getElementById('ota-enabled-btn').classList.contains('active');
      var otaCheckTime = document.getElementById('ota-check-time').value;

      var config = {
        city: city,
        cityLat: cityLat,
        cityLon: cityLon,
        stopId: stopId,
        stopName: stopName,
        filters: filters,
        weatherInterval: parseInt(weatherInterval),
        transportInterval: parseInt(transportInterval),
        transportActiveStart: transportActiveStart,
        transportActiveEnd: transportActiveEnd,
        walkingTime: parseInt(walkingTime),
        sleepStart: sleepStart,
        sleepEnd: sleepEnd,
        weekendMode: weekendMode,
        weekendTransportStart: weekendTransportStart,
        weekendTransportEnd: weekendTransportEnd,
        weekendSleepStart: weekendSleepStart,
        weekendSleepEnd: weekendSleepEnd,
        otaEnabled: otaEnabled,
        otaCheckTime: otaCheckTime
      };

      fetch('/save_config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      }).then(function(r) {
        if (!r.ok) throw new Error('Netzwerkfehler');
        return r.json();
      }).then(function(resp) {
        alert('Konfiguration gespeichert!');
      }).catch(function(e) {
        alert('Fehler beim Speichern: ' + e.message);
      });
    };

    // --- Weekend mode toggle ---
    document.getElementById('weekend-mode').addEventListener('change', function() {
      var weekendConfig = document.getElementById('weekend-config');
      if (this.checked) {
        weekendConfig.style.display = 'block';
      } else {
        weekendConfig.style.display = 'none';
      }
      calculateBatteryUsage();
    });

    // --- Battery Usage Calculator ---
    function calculateBatteryUsage() {
      var weatherInterval = parseInt(document.getElementById('weather-interval').value) || 3;
      var transportInterval = parseInt(document.getElementById('transport-interval').value) || 3;
      var activeStart = document.getElementById('transport-active-start').value || "06:00";
      var activeEnd = document.getElementById('transport-active-end').value || "09:00";
      var sleepStart = document.getElementById('sleep-start').value || "22:30";
      var sleepEnd = document.getElementById('sleep-end').value || "05:30";

      var activeStartMinutes = timeToMinutes(activeStart);
      var activeEndMinutes = timeToMinutes(activeEnd);
      var sleepStartMinutes = timeToMinutes(sleepStart);
      var sleepEndMinutes = timeToMinutes(sleepEnd);

      var sleepDuration = sleepEndMinutes < sleepStartMinutes ?
        (24 * 60 - sleepStartMinutes + sleepEndMinutes) :
        (sleepEndMinutes - sleepStartMinutes);

      var activeDuration = activeEndMinutes - activeStartMinutes;
      var sleepHours = Math.round(sleepDuration / 60 * 10) / 10;

      var weatherCallsPerDay = Math.floor(24 / weatherInterval);
      var transportActiveHours = Math.max(0, activeDuration / 60);
      var transportCallsPerDay = Math.floor(transportActiveHours * 60 / transportInterval);
      var totalCallsPerDay = weatherCallsPerDay + transportCallsPerDay;

      document.getElementById('total-calls-per-day').textContent = totalCallsPerDay;
      document.getElementById('weather-calls').textContent = weatherCallsPerDay;
      document.getElementById('transport-calls').textContent = transportCallsPerDay;
      document.getElementById('sleep-hours').textContent = sleepHours;

      var batteryInfo = document.getElementById('battery-usage-info');
      var recommendation = document.getElementById('battery-recommendation');

      if (totalCallsPerDay <= 50) {
        batteryInfo.style.background = '#e8f5e8';
        recommendation.textContent = 'üîã Exzellent! Sehr batteriefreundliche Einstellung - maximale Laufzeit.';
      } else if (totalCallsPerDay <= 100) {
        batteryInfo.style.background = '#fff3cd';
        recommendation.textContent = 'üîã Gut! Ausgewogene Einstellung zwischen Updates und Batterieverbrauch.';
      } else if (totalCallsPerDay <= 200) {
        batteryInfo.style.background = '#ffeaa7';
        recommendation.textContent = '‚ö†Ô∏è Mittel. H√§ufige Updates verbrauchen mehr Batterie.';
      } else {
        batteryInfo.style.background = '#fab1a0';
        recommendation.textContent = 'üî¥ Hoch! Sehr h√§ufige Updates - kurze Batterielebensdauer erwartet.';
      }
    }

    function timeToMinutes(timeStr) {
      var parts = timeStr.split(':');
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    }

    // Add event listeners for battery calculation
    document.getElementById('weather-interval').addEventListener('change', calculateBatteryUsage);
    document.getElementById('transport-interval').addEventListener('change', calculateBatteryUsage);
    document.getElementById('transport-active-start').addEventListener('change', calculateBatteryUsage);
    document.getElementById('transport-active-end').addEventListener('change', calculateBatteryUsage);
    document.getElementById('sleep-start').addEventListener('change', calculateBatteryUsage);
    document.getElementById('sleep-end').addEventListener('change', calculateBatteryUsage);

    // Calculate on page load
    setTimeout(calculateBatteryUsage, 100);

    // Set saved configuration values on page load
    setTimeout(function() {
      var weatherInterval = "{{WEATHER_INTERVAL}}";
      if (weatherInterval && document.getElementById('weather-interval')) {
        document.getElementById('weather-interval').value = weatherInterval;
      }

      var transportInterval = "{{TRANSPORT_INTERVAL}}";
      if (transportInterval && document.getElementById('transport-interval')) {
        document.getElementById('transport-interval').value = transportInterval;
      }

      var weekendMode = "{{WEEKEND_MODE}}" === "checked";
      if (weekendMode && document.getElementById('weekend-config')) {
        document.getElementById('weekend-config').style.display = 'block';
      }

      // Initialize OTA configuration toggle
      var otaEnabled = "{{OTA_ENABLED}}" === "true" || "{{OTA_ENABLED}}" === "1";
      toggleOTA(otaEnabled);

      // Set saved filter chips from server template
      var savedFilters = {{SAVED_FILTERS}};
      if (savedFilters && savedFilters.length > 0) {
        var allChips = document.querySelectorAll('.chip');
        allChips.forEach(function(chip) {
          chip.classList.remove('active');
        });

        savedFilters.forEach(function(filterType) {
          var chip = document.querySelector('.chip[data-type="' + filterType + '"]');
          if (chip) {
            chip.classList.add('active');
          }
        });
      }
    }, 150);

      // Initialize display mode preview
      document.addEventListener('DOMContentLoaded', function () {
          updateDisplayModePreview();
      });
  </script>
</body>
</html>
