; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

; Global configuration that applies to all environments
[platformio]
default_envs = esp32-s3-production

;	=====================
;	Shared configurations
;	=====================
; Dependencies for all device builds
[deps_app]
lib_deps =
    tzapu/WiFiManager@^2.0.17
    bblanchon/ArduinoJson@^6.21.4
    zinggjm/GxEPD2@^1.6.4
    olikraus/U8g2_for_Adafruit_GFX@^1.8.0
    bblanchon/StreamUtils@^1.9.0
    ricmoo/QRCode@^0.0.1

; Common configuration shared across environments
[env]
extends = deps_app
platform = espressif32@6.5.0
framework = arduino  ; Todo change to `espidf` for firmware encryption
monitor_speed = 115200
board_build.arduino.usb_mode = 0
board_build.arduino.usb_cdc_on_boot = 0
board_build.embed_txtfiles = cert/github.pem
board_build.filesystem = littlefs
board_build.flash_size = 4MB
; Predefined Partition https://github.com/espressif/arduino-esp32/tree/master/tools/partitions
; 1,572,864 Bytes -> 1.5 Mb
; 1,360,656 firmware.bin
board_build.partitions = huge_app.csv
build_flags =
    -Os                     ; Optimize for size instead of -Og
    -ffunction-sections     ; Each function → separate section
    -fdata-sections         ; Each variable → separate section
    -Wl,--gc-sections       ; Remove unused sections at link time
; Override WiFiManager strings to German
    -DWIFI_MANAGER_OVERRIDE_STRINGS
    -DWM_STRINGS_FILE=\"i18n/wm_strings_de.h\"
    -Iinclude                ;telling the compiler to also look in the include/ folder at the project root.


; Custom data group
; can be use in [env:***] via ${common.***}
[common]
version_flag = -D BUILD_TIME=$UNIX_TIME
               !echo '-D VERSION=\\"'$(git describe --tags)'\\"'
production_flag = -D PRODUCTION=1
                  -D CORE_DEBUG_LEVEL=0
debug_flag = -D PRODUCTION=0
             -D CORE_DEBUG_LEVEL=4


;;;;;; Possible options ;;;;;;
; https://docs.platformio.org/en/latest/platforms/espressif32.html#debug-level
;; None
;build_flags = -DCORE_DEBUG_LEVEL=0
;; Error
;build_flags = -DCORE_DEBUG_LEVEL=1
;; Warn
;build_flags = -DCORE_DEBUG_LEVEL=2
;; Info
;build_flags = -DCORE_DEBUG_LEVEL=3
;; Debug
;build_flags = -DCORE_DEBUG_LEVEL=4
;; Verbose
;build_flags = -DCORE_DEBUG_LEVEL=5

; Tests for Native (Desktop) Environment
; pio test -e native -v
[env:native]
platform = native
framework = ; No framework for native tests
lib_deps =  ; No libraries needed for native tests
test_build_src = yes
build_src_filter =
    -<*>
    +<util/timing_manager.cpp>
test_filter = test_timing_manager
extra_scripts =
build_unflags = -std=gnu++98  ; Remove old C++ standard if present
build_flags =
    -std=gnu++11  ; Use gnu++11 instead of c++11
    -Iinclude
    -Itest/mocks
    -DNATIVE_TEST
    -g          ; Debug symbols
    -O0         ; No optimization
lib_compat_mode = off

;	=====================
;	Base device configurations
;	=====================

[env:esp32-c3-base]
; 400 KB SRAM (16 KB for cache)
; 384 KB ROM
; 8 KB SRAM in RTC
; 4Mflash
extends = env
board = esp32-c3-devkitc-02
board_build.filesystem = littlefs
board_build.flash_size = 4MB
;board_build.partitions = partition/4MB-ota.csv
board_build.partitions = huge_app.csv
build_flags =
    ${env.build_flags}
    -D BOARD_ESP32_C3

[env:esp32-s3-base]
; Seeed Studio XIAO ESP32S3 Plus
; On-chip 8M PSRAM & 16MB Flash
; Charging battery current: 100mA
; Xtensa LX7 dual-core, 32-bit processor that operates at up to 240 MHz
; Bluetooth 5.0
extends = env
board = seeed_xiao_esp32s3
board_build.filesystem = littlefs
board_build.flash_size = 8MB
board_build.partitions = huge_app.csv
build_flags =
    ${env.build_flags}
; Enable PSRAM support
; https://docs.platformio.org/en/latest/platforms/espressif32.html#external-ram-psram
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -DBOARD_ESP32_S3
debug_init_break = tbreak main

;	=====================
;	Each device configurations
;	=====================

; Debug environment with verbose logging
[env:esp32-c3-debug]
extends = env:esp32-c3-base
board_build.arduino.usb_mode = 1
board_build.arduino.usb_cdc_on_boot = 1
build_flags =
    ${env:esp32-c3-base.build_flags}
;    ${common.version_flag}
    ${common.debug_flag}

; Release environment with minimal logging
[env:esp32-c3-production]
extends = env:esp32-c3-base
build_flags =
    ${env:esp32-c3-base.build_flags}
    ${common.version_flag}
    ${common.production_flag}

[env:esp32-s3-debug]
extends = env:esp32-s3-base
board_build.arduino.usb_mode = 1
board_build.arduino.usb_cdc_on_boot = 1
build_flags =
    ${env:esp32-s3-base.build_flags}
;    ${common.version_flag}
    ${common.debug_flag}

[env:esp32-s3-production]
extends = env:esp32-s3-base
build_flags =
    ${env:esp32-s3-base.build_flags}
    ${common.version_flag}
    ${common.production_flag}

